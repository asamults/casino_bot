name: Docker Smoke Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  docker-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build images
        run: |
          docker compose build --no-cache

      - name: Start Postgres
        run: |
          docker compose up -d postgres

      - name: Wait for Postgres healthcheck
        run: |
          echo "Waiting for Postgres to become healthy..."
          for i in {1..30}; do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' casino_bot-postgres || true)
            if [ "$STATUS" = "healthy" ]; then
              echo "Postgres is healthy"
              exit 0
            fi
            sleep 2
          done
          echo "Postgres did not become healthy"
          docker logs casino_bot-postgres
          exit 1

      - name: SQLAlchemy connection smoke-test
        run: |
          docker compose run --rm \
            -e DATABASE_URL=postgresql+psycopg://casino:secret@postgres:5432/casino_db \
            api \
            python - <<'EOF'
          from sqlalchemy import create_engine
          engine = create_engine(
              "postgresql+psycopg://casino:secret@postgres:5432/casino_db",
              pool_pre_ping=True,
          )
          with engine.connect() as conn:
              conn.execute("SELECT 1")
          print("OK: SQLAlchemy connection successful")
          EOF

      - name: Alembic upgrade check
        run: |
          docker compose run --rm \
            -e DATABASE_URL=postgresql+psycopg://casino:secret@postgres:5432/casino_db \
            api \
            alembic upgrade head

      - name: FastAPI startup smoke-test
        run: |
          docker compose up -d api
          sleep 10
          docker ps
          docker logs casino_bot-api --tail=100

      - name: Tear down
        if: always()
        run: |
          docker compose down -v
